<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vulnerability Management Workflows</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%); min-height: 100vh; }
        .glass-card { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(239, 68, 68, 0.2); }
        .workflow-box { background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(239, 68, 68, 0.3); font-family: 'Courier New', monospace; }
        .phase-automated { border-left: 4px solid #22c55e; }
        .phase-manual { border-left: 4px solid #f59e0b; }
        .phase-stop { border-left: 4px solid #ef4444; }
        .phase-context { border-left: 4px solid #3b82f6; }
        .phase-soc { border-left: 4px solid #8b5cf6; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body class="text-gray-100">
    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 z-50 glass-card border-b border-gray-800">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-lg bg-red-500/20 flex items-center justify-center">
                        <i class="fas fa-bug text-red-400"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-white">Vulnerability Management Workflows</h1>
                        <p class="text-xs text-gray-400">End-to-End Enterprise Process (11 Phases)</p>
                    </div>
                </div>
                <a href="workflows-index.html" class="text-gray-400 hover:text-red-400 transition-colors">
                    <i class="fas fa-th-large mr-2"></i>All Workflows
                </a>
            </div>
        </div>
    </nav>

    <div class="pt-24 pb-12 px-6">
        <div class="max-w-6xl mx-auto space-y-8">

            <!-- Key Concept Box -->
            <div class="bg-blue-500/10 border border-blue-500/50 rounded-xl p-6">
                <h3 class="text-blue-400 font-bold text-lg mb-3"><i class="fas fa-lightbulb mr-2"></i>Key Concept: Vulnerability Management ≠ SOC Workflow</h3>
                <p class="text-gray-300 text-sm mb-4">
                    Vulnerability management is <strong class="text-white">NOT</strong> a SOC incident workflow. SOC only engages when vulnerabilities are actively exploited. 
                    The vulnerability pipeline produces <strong class="text-white">prioritized findings for remediation teams</strong>, not SOC tickets.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-3">
                        <p class="text-green-400 font-semibold mb-1">✅ Vulnerability Management Output:</p>
                        <ul class="text-gray-400 text-xs space-y-1">
                            <li>• Power BI dashboards</li>
                            <li>• CSV exports for analysts</li>
                            <li>• ServiceNow/Jira tickets to asset owners</li>
                            <li>• SLA tracking reports</li>
                        </ul>
                    </div>
                    <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-3">
                        <p class="text-purple-400 font-semibold mb-1">⚡ When SOC Gets Involved:</p>
                        <ul class="text-gray-400 text-xs space-y-1">
                            <li>• NGFW detects exploit traffic</li>
                            <li>• EDR detects suspicious behavior</li>
                            <li>• Correlation rule links activity to known vuln</li>
                            <li>• Then → Sentinel Incident → SOC Investigation</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Legend -->
            <div class="glass-card rounded-xl p-4">
                <h3 class="text-white font-bold mb-3"><i class="fas fa-info-circle text-red-400 mr-2"></i>Legend</h3>
                <div class="flex flex-wrap gap-6 text-sm">
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 bg-green-500 rounded"></div>
                        <span class="text-gray-300">Automated</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 bg-blue-500 rounded"></div>
                        <span class="text-gray-300">Enrichment/Logic</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 bg-yellow-500 rounded"></div>
                        <span class="text-gray-300">Manual (Human)</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 bg-red-500 rounded"></div>
                        <span class="text-gray-300">Stop Point / Decision</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-4 h-4 bg-purple-500 rounded"></div>
                        <span class="text-gray-300">SOC (Only When Needed)</span>
                    </div>
                </div>
            </div>

            <!-- PHASE 1 -->
            <section>
                <h2 class="text-2xl font-bold text-white mb-4">
                    <span class="text-red-400">1.</span> Vulnerability Data Generation (Source of Truth)
                </h2>
                <div class="workflow-box rounded-xl p-6 mb-4 phase-automated">
                    <h3 class="text-green-400 font-bold mb-4"><i class="fas fa-radar mr-2"></i>1.1 Qualys / TVM Scan Execution</h3>
                    <pre class="text-gray-300 text-sm">
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           VULNERABILITY SCANNING SOURCES                                 │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌─────────────────────────────────┐       ┌─────────────────────────────────┐        │
│   │           QUALYS VMDR           │       │      MICROSOFT DEFENDER TVM      │        │
│   │                                 │       │                                 │        │
│   │  Scheduled authenticated scans  │       │  Continuous exposure assessment │        │
│   │  (weekly / daily)               │       │                                 │        │
│   │                                 │       │                                 │        │
│   │  Produces:                      │       │  Produces:                      │        │
│   │  ├── CVE identifiers            │       │  ├── Vulnerabilities            │        │
│   │  ├── CVSS scores                │       │  ├── Software inventory         │        │
│   │  ├── Detection proofs           │       │  ├── Exploitability indicators  │        │
│   │  └── Detection timestamps       │       │  └── Exposure metrics           │        │
│   │                                 │       │                                 │        │
│   │  Coverage:                      │       │  Coverage:                      │        │
│   │  • Infrastructure               │       │  • Endpoints                    │        │
│   │  • Servers                      │       │  • Servers with MDE             │        │
│   │  • Network devices              │       │  • Workstations                 │        │
│   └─────────────────────────────────┘       └─────────────────────────────────┘        │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │                        THESE TOOLS ANSWER:                                       │  │
│   │                  "What vulnerabilities exist and where?"                         │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                    </pre>
                </div>
            </section>

            <!-- PHASE 2 -->
            <section>
                <h2 class="text-2xl font-bold text-white mb-4">
                    <span class="text-red-400">2.</span> Data Ingestion into Sentinel (Raw Signals)
                </h2>
                <div class="workflow-box rounded-xl p-6 mb-4 phase-automated">
                    <h3 class="text-green-400 font-bold mb-4"><i class="fas fa-database mr-2"></i>2.1 Ingestion Paths</h3>
                    <pre class="text-gray-300 text-sm">
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              DATA INGESTION INTO SENTINEL                                │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌─────────────────────┐                      ┌─────────────────────────────────────┐ │
│   │       QUALYS        │                      │         LOG ANALYTICS               │ │
│   │                     │──── API Connector ──▶│                                     │ │
│   │  Scanner Results    │     / Logic App      │  Custom Table: QualysVuln_CL        │ │
│   └─────────────────────┘                      │                                     │ │
│                                                │  TVM Tables (Native):               │ │
│   ┌─────────────────────┐                      │  • DeviceTvmSoftwareVulnerabilities │ │
│   │   DEFENDER TVM      │                      │  • DeviceTvmSecureConfigAssessment  │ │
│   │                     │── Native Connector ─▶│  • DeviceTvmSoftwareInventory       │ │
│   │  Continuous Data    │                      │                                     │ │
│   └─────────────────────┘                      └─────────────────────────────────────┘ │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │  AT THIS STAGE:                                                                  │  │
│   │  ├── Data is RAW                                                                │  │
│   │  ├── HIGH VOLUME (thousands of findings)                                        │  │
│   │  └── NOT ACTIONABLE without enrichment                                          │  │
│   │                                                                                  │  │
│   │  ❌ NO SOC INVOLVEMENT HERE                                                      │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                    </pre>
                </div>
            </section>

            <!-- PHASE 3 -->
            <section>
                <h2 class="text-2xl font-bold text-white mb-4">
                    <span class="text-red-400">3.</span> Enrichment & Contextualization (Critical Step)
                    <span class="ml-3 px-3 py-1 bg-emerald-500/20 text-emerald-400 text-sm rounded-full">YOUR AUTOMATION</span>
                </h2>
                <div class="bg-emerald-500/10 border border-emerald-500/50 rounded-xl p-4 mb-4">
                    <p class="text-emerald-400 font-bold"><i class="fas fa-star mr-2"></i>This is where YOUR automation and correlation logic lives</p>
                </div>
                <div class="workflow-box rounded-xl p-6 mb-4 phase-context">
                    <h3 class="text-blue-400 font-bold mb-4"><i class="fas fa-layer-group mr-2"></i>3.1 External Enrichment Sources</h3>
                    <pre class="text-gray-300 text-sm">
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              ENRICHMENT DATA SOURCES                                     │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│   ┌──────────────────────────────────────────────────────────────────────────────────┐ │
│   │ EPSS (Exploit Prediction Scoring System) - FIRST.org                             │ │
│   │ Adds: Probability of exploitation in next 30 days (0.0 - 1.0)                    │ │
│   └──────────────────────────────────────────────────────────────────────────────────┘ │
│   ┌──────────────────────────────────────────────────────────────────────────────────┐ │
│   │ CISA KEV (Known Exploited Vulnerabilities)                                        │ │
│   │ Adds: Boolean flag - Is this CVE being actively exploited in the wild?           │ │
│   └──────────────────────────────────────────────────────────────────────────────────┘ │
│   ┌──────────────────────────────────────────────────────────────────────────────────┐ │
│   │ CMDB / Asset Criticality Watchlist                                                │ │
│   │ Adds: Asset Tier (Tier 0/1/2), Business Owner, Support Group                     │ │
│   └──────────────────────────────────────────────────────────────────────────────────┘ │
│   ┌──────────────────────────────────────────────────────────────────────────────────┐ │
│   │ Exposure Context                                                                  │ │
│   │ Adds: Internet-facing?, Firewall reachability, Network zone (DMZ/Internal/OT)    │ │
│   └──────────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                    </pre>
                </div>

                <!-- EPSS INTEGRATION ARCHITECTURE -->
                <div class="workflow-box rounded-xl p-6 mb-4 phase-context">
                    <h3 class="text-blue-400 font-bold mb-4"><i class="fas fa-project-diagram mr-2"></i>3.2 EPSS Integration Architecture (FIRST.org → Sentinel)</h3>
                    <p class="text-gray-400 text-sm mb-4">Complete data pipeline for ingesting EPSS scores into Microsoft Sentinel for vulnerability risk scoring.</p>
                    
                    <div class="bg-black/50 rounded-lg p-4 overflow-x-auto mb-4">
                        <pre class="text-xs text-cyan-400">
┌──────────────────────────┐
│        FIRST EPSS        │
│   Public REST API        │
│  (epss.score, percentile │
│   per CVE per date)      │
│                          │
│  api.first.org/data/v1/  │
│  epss?cve=CVE-XXXX-XXXX  │
└─────────────┬────────────┘
              │ HTTPS (GET)
              │ Paging (offset/limit)
              │ ~240K CVEs daily
              ▼
┌──────────────────────────┐
│   Azure Function App     │
│  (Timer Trigger - Daily) │
│                          │
│  • Fetch EPSS data       │
│  • Handle paging         │
│  • Transform JSON        │
│  • Batch records (500)   │
│  • Retry / error logic   │
│  • Managed Identity auth │
└─────────────┬────────────┘
              │ HTTPS (Logs Ingestion API)
              │ Entra ID Auth (Managed Identity)
              │ POST /dataCollectionRules/{DCR}/streams/{stream}
              ▼
┌──────────────────────────┐
│ Data Collection Endpoint │
│          (DCE)           │
│                          │
│  Ingestion Endpoint URL: │
│  https://dce-xxx.ingest  │
│  .monitor.azure.com      │
└─────────────┬────────────┘
              │
              │ governed by
              ▼
┌──────────────────────────┐
│  Data Collection Rule    │
│          (DCR)           │
│                          │
│  • Defines stream name   │
│  • Maps input → output   │
│  • Schema transformation │
│  • Routes to LAW table   │
└─────────────┬────────────┘
              │
              ▼
┌──────────────────────────┐
│ Log Analytics Workspace  │
│                          │
│  Custom Table: EPSS_CL   │
│                          │
│  TimeGenerated | CVE |   │
│  EpssScore | Percentile  │
└─────────────┬────────────┘
              │
              ▼
┌──────────────────────────┐
│   Microsoft Sentinel     │
│                          │
│  • KQL joins with        │
│    Qualys / TVM vulns    │
│  • Risk score calc       │
│  • Correlation rules     │
│  • Logic App automation  │
└──────────────────────────┘
                        </pre>
                    </div>

                    <!-- Component Details -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="bg-black/30 rounded-lg p-4">
                            <p class="text-cyan-400 font-semibold text-sm mb-2"><i class="fas fa-globe mr-2"></i>FIRST EPSS API</p>
                            <ul class="text-gray-400 text-xs space-y-1">
                                <li>• <strong>Endpoint:</strong> api.first.org/data/v1/epss</li>
                                <li>• <strong>Data:</strong> ~240,000 CVEs with daily scores</li>
                                <li>• <strong>Format:</strong> JSON (CVE, EPSS score 0.0-1.0, percentile)</li>
                                <li>• <strong>Rate Limit:</strong> Reasonable (use paging)</li>
                                <li>• <strong>Update:</strong> Daily refresh recommended</li>
                            </ul>
                        </div>
                        <div class="bg-black/30 rounded-lg p-4">
                            <p class="text-purple-400 font-semibold text-sm mb-2"><i class="fas fa-bolt mr-2"></i>Azure Function App</p>
                            <ul class="text-gray-400 text-xs space-y-1">
                                <li>• <strong>Trigger:</strong> Timer (0 0 6 * * * = 6 AM daily)</li>
                                <li>• <strong>Runtime:</strong> Python 3.11 or PowerShell 7</li>
                                <li>• <strong>Auth:</strong> System-assigned Managed Identity</li>
                                <li>• <strong>Batching:</strong> 500 records per API call</li>
                                <li>• <strong>Retry:</strong> Exponential backoff on failures</li>
                            </ul>
                        </div>
                        <div class="bg-black/30 rounded-lg p-4">
                            <p class="text-emerald-400 font-semibold text-sm mb-2"><i class="fas fa-database mr-2"></i>DCE/DCR Configuration</p>
                            <ul class="text-gray-400 text-xs space-y-1">
                                <li>• <strong>DCE:</strong> Data Collection Endpoint (regional)</li>
                                <li>• <strong>DCR:</strong> Defines schema mapping</li>
                                <li>• <strong>Stream:</strong> Custom-EPSS_CL</li>
                                <li>• <strong>RBAC:</strong> Monitoring Metrics Publisher role</li>
                                <li>• <strong>Schema:</strong> TimeGenerated, CVE, EpssScore, Percentile</li>
                            </ul>
                        </div>
                        <div class="bg-black/30 rounded-lg p-4">
                            <p class="text-yellow-400 font-semibold text-sm mb-2"><i class="fas fa-table mr-2"></i>EPSS_CL Table Schema</p>
                            <ul class="text-gray-400 text-xs space-y-1">
                                <li>• <strong>TimeGenerated:</strong> datetime (required)</li>
                                <li>• <strong>CVE:</strong> string (CVE-XXXX-XXXXX)</li>
                                <li>• <strong>EpssScore:</strong> real (0.0 - 1.0)</li>
                                <li>• <strong>Percentile:</strong> real (0.0 - 1.0)</li>
                                <li>• <strong>Retention:</strong> 30-90 days (adjust to need)</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Azure Function Code -->
                <div class="workflow-box rounded-xl p-6 mb-4 phase-context">
                    <h3 class="text-blue-400 font-bold mb-4"><i class="fas fa-code mr-2"></i>3.3 Azure Function: EPSS Data Ingestion (Python)</h3>
                    <div class="bg-black/50 rounded-lg p-4 overflow-x-auto">
                        <pre class="text-xs text-yellow-400">
# ============================================================================
# Azure Function: EPSS Data Ingestion to Sentinel
# Trigger: Timer (daily at 6 AM UTC)
# Auth: Managed Identity → Logs Ingestion API
# ============================================================================

import azure.functions as func
import logging
import requests
import json
from datetime import datetime, timezone
from azure.identity import DefaultAzureCredential
from azure.monitor.ingestion import LogsIngestionClient

app = func.FunctionApp()

# Configuration (set in Function App Settings)
DCE_ENDPOINT = "https://dce-xxxxx.eastus-1.ingest.monitor.azure.com"
DCR_IMMUTABLE_ID = "dcr-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
STREAM_NAME = "Custom-EPSS_CL"
EPSS_API_BASE = "https://api.first.org/data/v1/epss"
BATCH_SIZE = 500

@app.timer_trigger(schedule="0 0 6 * * *", arg_name="timer", run_on_startup=False)
def epss_ingestion(timer: func.TimerRequest) -> None:
    logging.info("EPSS ingestion function started")
    
    try:
        # Authenticate using Managed Identity
        credential = DefaultAzureCredential()
        client = LogsIngestionClient(endpoint=DCE_ENDPOINT, credential=credential)
        
        # Fetch all EPSS data with paging
        all_records = []
        offset = 0
        limit = 1000  # FIRST API page size
        
        while True:
            url = f"{EPSS_API_BASE}?offset={offset}&limit={limit}"
            response = requests.get(url, timeout=60)
            response.raise_for_status()
            
            data = response.json()
            records = data.get("data", [])
            
            if not records:
                break
                
            # Transform to Sentinel schema
            for record in records:
                all_records.append({
                    "TimeGenerated": datetime.now(timezone.utc).isoformat(),
                    "CVE": record.get("cve"),
                    "EpssScore": float(record.get("epss", 0)),
                    "Percentile": float(record.get("percentile", 0))
                })
            
            offset += limit
            logging.info(f"Fetched {len(all_records)} EPSS records so far...")
            
            # Check if we've reached the end
            if len(records) < limit:
                break
        
        logging.info(f"Total EPSS records fetched: {len(all_records)}")
        
        # Batch upload to Sentinel via Logs Ingestion API
        for i in range(0, len(all_records), BATCH_SIZE):
            batch = all_records[i:i + BATCH_SIZE]
            client.upload(
                rule_id=DCR_IMMUTABLE_ID,
                stream_name=STREAM_NAME,
                logs=batch
            )
            logging.info(f"Uploaded batch {i // BATCH_SIZE + 1}")
        
        logging.info(f"EPSS ingestion complete: {len(all_records)} records uploaded")
        
    except Exception as e:
        logging.error(f"EPSS ingestion failed: {str(e)}")
        raise
                        </pre>
                    </div>
                    
                    <div class="mt-4 bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                        <p class="text-blue-400 font-semibold text-sm mb-2"><i class="fas fa-cog mr-2"></i>Required Function App Settings:</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                            <code class="text-gray-400 bg-black/30 p-1 rounded">DCE_ENDPOINT = "https://dce-xxx.ingest.monitor.azure.com"</code>
                            <code class="text-gray-400 bg-black/30 p-1 rounded">DCR_IMMUTABLE_ID = "dcr-xxxxxxxxxxxx"</code>
                            <code class="text-gray-400 bg-black/30 p-1 rounded">STREAM_NAME = "Custom-EPSS_CL"</code>
                            <code class="text-gray-400 bg-black/30 p-1 rounded">Managed Identity = System-assigned (ENABLED)</code>
                        </div>
                    </div>
                </div>

                <!-- DCR ARM Template -->
                <div class="workflow-box rounded-xl p-6 mb-4 phase-context">
                    <h3 class="text-blue-400 font-bold mb-4"><i class="fas fa-file-code mr-2"></i>3.4 Data Collection Rule (DCR) - ARM Template</h3>
                    <div class="bg-black/50 rounded-lg p-4 overflow-x-auto">
                        <pre class="text-xs text-emerald-400">
{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "resources": [
        {
            "type": "Microsoft.Insights/dataCollectionRules",
            "apiVersion": "2022-06-01",
            "name": "DCR-EPSS-Ingestion",
            "location": "[resourceGroup().location]",
            "properties": {
                "dataCollectionEndpointId": "[resourceId('Microsoft.Insights/dataCollectionEndpoints', 'DCE-Security-Ingestion')]",
                "streamDeclarations": {
                    "Custom-EPSS_CL": {
                        "columns": [
                            { "name": "TimeGenerated", "type": "datetime" },
                            { "name": "CVE", "type": "string" },
                            { "name": "EpssScore", "type": "real" },
                            { "name": "Percentile", "type": "real" }
                        ]
                    }
                },
                "destinations": {
                    "logAnalytics": [
                        {
                            "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', 'LAW-Sentinel-Prod')]",
                            "name": "SentinelWorkspace"
                        }
                    ]
                },
                "dataFlows": [
                    {
                        "streams": [ "Custom-EPSS_CL" ],
                        "destinations": [ "SentinelWorkspace" ],
                        "transformKql": "source | extend TimeGenerated = todatetime(TimeGenerated)",
                        "outputStream": "Custom-EPSS_CL"
                    }
                ]
            }
        }
    ]
}
                        </pre>
                    </div>
                </div>

                <!-- RBAC and Managed Identity Setup -->
                <div class="workflow-box rounded-xl p-6 mb-4 phase-context">
                    <h3 class="text-blue-400 font-bold mb-4"><i class="fas fa-key mr-2"></i>3.5 RBAC & Managed Identity Configuration</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-black/30 rounded-lg p-4">
                            <p class="text-purple-400 font-semibold text-sm mb-2">Step 1: Enable Managed Identity</p>
                            <pre class="text-gray-400 text-xs">
# Azure CLI
az functionapp identity assign \
  --name "func-epss-ingestion" \
  --resource-group "rg-security-automation"

# Returns:
# principalId: "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                            </pre>
                        </div>
                        <div class="bg-black/30 rounded-lg p-4">
                            <p class="text-purple-400 font-semibold text-sm mb-2">Step 2: Assign DCR Permissions</p>
                            <pre class="text-gray-400 text-xs">
# Grant "Monitoring Metrics Publisher" on DCR
az role assignment create \
  --assignee "[principalId]" \
  --role "Monitoring Metrics Publisher" \
  --scope "/subscriptions/{sub}/resourceGroups/{rg}/
    providers/Microsoft.Insights/
    dataCollectionRules/DCR-EPSS-Ingestion"
                            </pre>
                        </div>
                    </div>
                    
                    <div class="mt-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                        <p class="text-yellow-400 font-semibold text-sm mb-2"><i class="fas fa-exclamation-triangle mr-2"></i>Common Pitfalls:</p>
                        <ul class="text-gray-400 text-xs space-y-1">
                            <li>• <strong>Wrong role:</strong> Must be "Monitoring Metrics Publisher", not "Log Analytics Contributor"</li>
                            <li>• <strong>Wrong scope:</strong> Role must be assigned on the DCR, not the workspace</li>
                            <li>• <strong>Region mismatch:</strong> DCE must be in same region as Log Analytics Workspace</li>
                            <li>• <strong>Stream name:</strong> Must match exactly between DCR and Function code (case-sensitive)</li>
                            <li>• <strong>Table creation:</strong> Custom table (EPSS_CL) auto-created on first ingestion</li>
                        </ul>
                    </div>
                </div>

                <!-- KQL Validation Queries -->
                <div class="workflow-box rounded-xl p-6 mb-4 phase-context">
                    <h3 class="text-blue-400 font-bold mb-4"><i class="fas fa-search mr-2"></i>3.6 Validation KQL Queries</h3>
                    <div class="bg-black/50 rounded-lg p-4 overflow-x-auto">
                        <pre class="text-xs text-cyan-400">
// ============================================================================
// EPSS DATA VALIDATION QUERIES
// ============================================================================

// 1. Check EPSS data freshness
EPSS_CL
| summarize 
    LatestIngestion = max(TimeGenerated),
    TotalRecords = count(),
    DistinctCVEs = dcount(CVE)
| extend 
    DataAge = datetime_diff('hour', now(), LatestIngestion),
    IsStale = datetime_diff('hour', now(), LatestIngestion) > 36

// 2. Top 20 highest EPSS scores (most likely to be exploited)
EPSS_CL
| where TimeGenerated > ago(2d)
| summarize EpssScore = max(EpssScore), Percentile = max(Percentile) by CVE
| top 20 by EpssScore desc

// 3. Join EPSS with Qualys vulnerabilities for risk scoring
QualysVuln_CL
| where todatetime(LastDetected) > ago(14d)
| extend CVE = tostring(CVE)
| join kind=leftouter (
    EPSS_CL 
    | where TimeGenerated > ago(2d)
    | summarize EpssScore = max(EpssScore), Percentile = max(Percentile) by CVE
) on CVE
| extend 
    EpssScore = coalesce(EpssScore, 0.0),
    RiskBoost = EpssScore * 50  // Scale 0-1 to 0-50 points
| project AssetName, CVE, Cvss, EpssScore, RiskBoost
| order by EpssScore desc

// 4. EPSS coverage check (what % of our vulns have EPSS scores?)
let OurCVEs = QualysVuln_CL | where todatetime(LastDetected) > ago(14d) | distinct CVE;
let EPSSCVEs = EPSS_CL | where TimeGenerated > ago(2d) | distinct CVE;
OurCVEs
| summarize TotalCVEs = count()
| extend 
    WithEPSS = toscalar(OurCVEs | join kind=inner EPSSCVEs on CVE | count),
    CoveragePercent = round(100.0 * toscalar(OurCVEs | join kind=inner EPSSCVEs on CVE | count) / count(), 1)
                        </pre>
                    </div>
                </div>

                <!-- CISA KEV Integration (Similar Pattern) -->
                <div class="workflow-box rounded-xl p-6 mb-4 phase-context">
                    <h3 class="text-blue-400 font-bold mb-4"><i class="fas fa-shield-alt mr-2"></i>3.7 CISA KEV Integration (Same Pattern)</h3>
                    <p class="text-gray-400 text-sm mb-4">CISA KEV uses the same ingestion pattern as EPSS. The only differences are the API endpoint and schema.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-black/30 rounded-lg p-4">
                            <p class="text-red-400 font-semibold text-sm mb-2"><i class="fas fa-globe mr-2"></i>CISA KEV API</p>
                            <ul class="text-gray-400 text-xs space-y-1">
                                <li>• <strong>URL:</strong> www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json</li>
                                <li>• <strong>Format:</strong> JSON (single file, ~1000 CVEs)</li>
                                <li>• <strong>Update:</strong> When CISA adds new KEVs</li>
                                <li>• <strong>No paging:</strong> Small dataset, single request</li>
                            </ul>
                        </div>
                        <div class="bg-black/30 rounded-lg p-4">
                            <p class="text-red-400 font-semibold text-sm mb-2"><i class="fas fa-table mr-2"></i>CISA_KEV_CL Schema</p>
                            <ul class="text-gray-400 text-xs space-y-1">
                                <li>• <strong>TimeGenerated:</strong> datetime</li>
                                <li>• <strong>CVE:</strong> string</li>
                                <li>• <strong>VendorProject:</strong> string</li>
                                <li>• <strong>Product:</strong> string</li>
                                <li>• <strong>DateAdded:</strong> datetime</li>
                                <li>• <strong>DueDate:</strong> datetime (remediation deadline)</li>
                                <li>• <strong>IsKEV:</strong> bool (always true)</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mt-4 bg-red-500/10 border border-red-500/30 rounded-lg p-4">
                        <p class="text-red-400 font-semibold text-sm mb-2"><i class="fas fa-exclamation-circle mr-2"></i>KEV Priority:</p>
                        <p class="text-gray-400 text-xs">CVEs in CISA KEV are <strong class="text-white">actively exploited in the wild</strong>. They should receive the highest priority boost in your risk scoring (e.g., +100 points). Federal agencies have mandatory remediation deadlines; private sector should treat similarly.</p>
                    </div>
                </div>

                <!-- Interview Talking Point -->
                <div class="bg-yellow-500/10 border border-yellow-500/50 rounded-xl p-4 mb-4">
                    <p class="text-yellow-400 font-bold mb-2"><i class="fas fa-microphone mr-2"></i>Interview Talking Point: EPSS Integration</p>
                    <p class="text-gray-300 text-sm">
                        "I built an automated pipeline to ingest EPSS scores from FIRST.org into Sentinel. An Azure Function runs daily, fetches ~240,000 CVE scores via the public API with paging, transforms the data, and pushes it to a custom Log Analytics table via the Logs Ingestion API using Managed Identity authentication. The DCR defines the schema mapping, and in Sentinel I join EPSS_CL with our vulnerability data from Qualys and TVM. EPSS adds up to 50 points to our risk score—a CVE with 0.95 EPSS (95% probability of exploitation in 30 days) gets treated very differently than one with 0.02 EPSS, even if they have the same CVSS."
                    </p>
                </div>

                <!-- FULL KQL CORRELATION RULE -->
                <div class="workflow-box rounded-xl p-6 mb-4 phase-context">
                    <h3 class="text-blue-400 font-bold mb-4"><i class="fas fa-code mr-2"></i>3.8 Complete Correlation Rule (Production KQL)</h3>
                    <div class="bg-black/50 rounded-lg p-4 overflow-x-auto">
                        <pre class="text-xs text-cyan-400">
// ============================================================================
// VULNERABILITY RISK SCORING CORRELATION RULE
// Scheduled Analytics Rule - Runs every 4 hours
// Incident Creation: OFF (alerts trigger automation, not SOC)
// ============================================================================

// ----- STEP 1: Load Enrichment Watchlists -----
let EPSS_Scores = _GetWatchlist('EPSS_Scores')
    | project CveId = CVE, EPSS_Score = todouble(EPSS), EPSS_Percentile = todouble(Percentile);

let CISA_KEV = _GetWatchlist('CISA_KEV')
    | project CveId = CVE, KEV_DateAdded = todatetime(DateAdded), 
              KEV_DueDate = todatetime(DueDate), KEV_Vendor = Vendor;

let Asset_Criticality = _GetWatchlist('Asset_Criticality')
    | project DeviceName = Hostname, AssetTier, BusinessUnit, 
              AssetOwner = Owner, SupportGroup, InternetFacing = tobool(InternetFacing);

let Exposure_Context = _GetWatchlist('Exposure_Context')
    | project DeviceName = Hostname, NetworkZone, FirewallReachable = tobool(Reachable),
              DMZ = tobool(InDMZ);

// ----- STEP 2: Get TVM Vulnerabilities (Last 4 hours of new detections) -----
let TVM_Vulns = DeviceTvmSoftwareVulnerabilities
    | where TimeGenerated > ago(4h)
    | project 
        TimeGenerated,
        DeviceId,
        DeviceName,
        CveId,
        VulnerabilitySeverityLevel,
        CvssScore,
        SoftwareName,
        SoftwareVersion,
        RecommendedSecurityUpdate;

// ----- STEP 3: Get Qualys Vulnerabilities (if using Qualys) -----
let Qualys_Vulns = QualysVuln_CL
    | where TimeGenerated > ago(4h)
    | project
        TimeGenerated,
        DeviceName = Computer_s,
        CveId = CVE_s,
        CvssScore = CVSS_d,
        QualysQID = QID_s,
        Severity = Severity_s;

// ----- STEP 4: Union TVM + Qualys (deduplicate by CVE+Device) -----
let All_Vulns = TVM_Vulns
    | union Qualys_Vulns
    | summarize arg_max(TimeGenerated, *) by CveId, DeviceName;

// ----- STEP 5: Enrich with EPSS -----
let Enriched_EPSS = All_Vulns
    | join kind=leftouter EPSS_Scores on CveId
    | extend EPSS_Score = coalesce(EPSS_Score, 0.0);

// ----- STEP 6: Enrich with CISA KEV -----
let Enriched_KEV = Enriched_EPSS
    | join kind=leftouter CISA_KEV on CveId
    | extend 
        InKEV = isnotempty(KEV_DateAdded),
        KEV_Overdue = iff(isnotempty(KEV_DueDate), now() > KEV_DueDate, false);

// ----- STEP 7: Enrich with Asset Criticality -----
let Enriched_Asset = Enriched_KEV
    | join kind=leftouter Asset_Criticality on DeviceName
    | extend 
        AssetTier = coalesce(AssetTier, "Tier3"),
        InternetFacing = coalesce(InternetFacing, false);

// ----- STEP 8: Enrich with Exposure Context -----
let Enriched_Exposure = Enriched_Asset
    | join kind=leftouter Exposure_Context on DeviceName
    | extend 
        NetworkZone = coalesce(NetworkZone, "Internal"),
        InDMZ = coalesce(DMZ, false);

// ----- STEP 9: Calculate Risk Score -----
let Scored_Vulns = Enriched_Exposure
    | extend 
        // Base CVSS Score (0-100 scale)
        CVSS_Points = CvssScore * 10,
        
        // EPSS Multiplier (high exploit probability = higher score)
        EPSS_Points = EPSS_Score * 50,
        
        // CISA KEV (actively exploited = critical)
        KEV_Points = iff(InKEV, 100, 0),
        KEV_Overdue_Points = iff(KEV_Overdue, 50, 0),
        
        // Asset Criticality
        Asset_Points = case(
            AssetTier == "Tier0", 75,  // Domain Controllers, PKI, PAM
            AssetTier == "Tier1", 50,  // Critical business apps
            AssetTier == "Tier2", 25,  // Standard servers
            10                          // Workstations, other
        ),
        
        // Exposure
        Exposure_Points = case(
            InternetFacing and InDMZ, 50,  // Internet-facing in DMZ
            InternetFacing, 40,             // Internet-facing
            InDMZ, 25,                      // DMZ but not internet-facing
            NetworkZone == "OT", 30,        // OT network (sensitive)
            0                               // Internal only
        )
    | extend 
        RiskScore = CVSS_Points + EPSS_Points + KEV_Points + KEV_Overdue_Points + Asset_Points + Exposure_Points;

// ----- STEP 10: Assign Priority Tier and SLA -----
let Prioritized_Vulns = Scored_Vulns
    | extend 
        PriorityTier = case(
            RiskScore >= 200, "Critical",
            RiskScore >= 150, "High",
            RiskScore >= 100, "Medium",
            "Low"
        ),
        SLA_Days = case(
            RiskScore >= 200, 2,    // 48 hours
            RiskScore >= 150, 7,    // 7 days
            RiskScore >= 100, 30,   // 30 days
            90                       // 90 days
        ),
        SLA_Deadline = case(
            RiskScore >= 200, now() + 2d,
            RiskScore >= 150, now() + 7d,
            RiskScore >= 100, now() + 30d,
            now() + 90d
        );

// ----- STEP 11: Final Output (Only High-Risk for Alerting) -----
Prioritized_Vulns
| where RiskScore >= 150  // Only Critical and High trigger alerts
| project 
    TimeGenerated,
    DeviceName,
    CveId,
    CvssScore,
    EPSS_Score,
    InKEV,
    KEV_Overdue,
    AssetTier,
    AssetOwner,
    BusinessUnit,
    SupportGroup,
    InternetFacing,
    NetworkZone,
    RiskScore,
    PriorityTier,
    SLA_Days,
    SLA_Deadline,
    RecommendedAction = case(
        InKEV and KEV_Overdue, "URGENT: CISA KEV overdue - patch immediately",
        InKEV, strcat("CISA KEV - patch by ", format_datetime(KEV_DueDate, 'yyyy-MM-dd')),
        RiskScore >= 200, "Critical risk - patch within 48 hours",
        RiskScore >= 150, "High risk - patch within 7 days",
        "Schedule remediation per SLA"
    ),
    SoftwareName,
    RecommendedSecurityUpdate
| sort by RiskScore desc
                        </pre>
                    </div>
                    
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-black/30 rounded-lg p-3">
                            <p class="text-yellow-400 font-semibold text-sm mb-2">Risk Score Weights:</p>
                            <ul class="text-gray-400 text-xs space-y-1">
                                <li>• CVSS × 10 = 0-100 points</li>
                                <li>• EPSS × 50 = 0-50 points</li>
                                <li>• CISA KEV = +100 points</li>
                                <li>• KEV Overdue = +50 points</li>
                                <li>• Tier 0 Asset = +75 points</li>
                                <li>• Internet-facing = +40-50 points</li>
                            </ul>
                        </div>
                        <div class="bg-black/30 rounded-lg p-3">
                            <p class="text-yellow-400 font-semibold text-sm mb-2">SLA Mapping:</p>
                            <ul class="text-gray-400 text-xs space-y-1">
                                <li>• Critical (≥200): 48 hours</li>
                                <li>• High (150-199): 7 days</li>
                                <li>• Medium (100-149): 30 days</li>
                                <li>• Low (&lt;100): 90 days</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Watchlist Schema -->
                <div class="workflow-box rounded-xl p-6 mb-4 phase-context">
                    <h3 class="text-blue-400 font-bold mb-4"><i class="fas fa-table mr-2"></i>3.3 Watchlist Schemas</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-black/30 rounded-lg p-3">
                            <p class="text-cyan-400 font-semibold text-sm mb-2">EPSS_Scores Watchlist:</p>
                            <pre class="text-xs text-gray-400">
CVE,EPSS,Percentile
CVE-2024-1234,0.92,99.5
CVE-2024-5678,0.45,85.2
CVE-2024-9012,0.12,45.0
                            </pre>
                            <p class="text-gray-500 text-xs mt-2">Updated daily via Logic App from FIRST.org API</p>
                        </div>
                        <div class="bg-black/30 rounded-lg p-3">
                            <p class="text-cyan-400 font-semibold text-sm mb-2">CISA_KEV Watchlist:</p>
                            <pre class="text-xs text-gray-400">
CVE,DateAdded,DueDate,Vendor
CVE-2024-1234,2024-01-15,2024-01-29,Microsoft
CVE-2024-5678,2024-02-01,2024-02-15,Apache
                            </pre>
                            <p class="text-gray-500 text-xs mt-2">Updated daily via Logic App from CISA catalog</p>
                        </div>
                        <div class="bg-black/30 rounded-lg p-3">
                            <p class="text-cyan-400 font-semibold text-sm mb-2">Asset_Criticality Watchlist:</p>
                            <pre class="text-xs text-gray-400">
Hostname,AssetTier,Owner,SupportGroup,InternetFacing
DC-01,Tier0,john.doe,AD-Team,false
WEB-PROD-01,Tier1,jane.smith,Web-Team,true
APP-DEV-01,Tier2,dev.team,App-Team,false
                            </pre>
                            <p class="text-gray-500 text-xs mt-2">Synced weekly from ServiceNow CMDB</p>
                        </div>
                        <div class="bg-black/30 rounded-lg p-3">
                            <p class="text-cyan-400 font-semibold text-sm mb-2">Exposure_Context Watchlist:</p>
                            <pre class="text-xs text-gray-400">
Hostname,NetworkZone,Reachable,InDMZ
WEB-PROD-01,DMZ,true,true
DC-01,Internal,false,false
OT-PLC-01,OT,false,false
                            </pre>
                            <p class="text-gray-500 text-xs mt-2">Derived from firewall rules and network inventory</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PHASE 4 -->
            <section>
                <h2 class="text-2xl font-bold text-white mb-4">
                    <span class="text-red-400">4.</span> Threshold Evaluation → Alerts (Not Incidents)
                </h2>
                
                <div class="workflow-box rounded-xl p-6 mb-4 phase-automated">
                    <h3 class="text-green-400 font-bold mb-4"><i class="fas fa-bell mr-2"></i>4.1 Sentinel Analytics Rule Configuration</h3>
                    <pre class="text-gray-300 text-sm">
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                         ANALYTICS RULE CONFIGURATION                                     │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   Rule Name:        "High-Risk Vulnerability Detected"                                  │
│   Description:      "Prioritized vulnerability requiring remediation action"            │
│   Severity:         Medium (this is for automation, not SOC priority)                  │
│   MITRE ATT&CK:     Initial Access (T1190 - Exploit Public-Facing Application)         │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │  RULE LOGIC (uses the KQL from Phase 3)                                         │  │
│   │                                                                                  │  │
│   │  Frequency:        Every 4 hours                                                │  │
│   │  Lookback:         4 hours                                                      │  │
│   │  Alert Threshold:  Greater than 0 results                                       │  │
│   │                                                                                  │  │
│   │  Event Grouping:   Group all events into a single alert                         │  │
│   │                    (Logic App will process individual findings)                 │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │  ⚠️  CRITICAL SETTINGS:                                                          │  │
│   │                                                                                  │  │
│   │  ┌───────────────────────────────────────────────────────────────────────────┐  │  │
│   │  │  Incident Settings:                                                       │  │  │
│   │  │                                                                           │  │  │
│   │  │  Create incidents from alerts = ❌ DISABLED                               │  │  │
│   │  │                                                                           │  │  │
│   │  │  WHY: These alerts are NOT for SOC triage. They trigger automation       │  │  │
│   │  │       that routes findings to vulnerability analysts via Power BI/CSV.   │  │  │
│   │  └───────────────────────────────────────────────────────────────────────────┘  │  │
│   │                                                                                  │  │
│   │  ┌───────────────────────────────────────────────────────────────────────────┐  │  │
│   │  │  Automated Response:                                                      │  │  │
│   │  │                                                                           │  │  │
│   │  │  Run Playbook = ✅ ENABLED                                                │  │  │
│   │  │  Playbook:     "Vuln-ProcessHighRiskFindings"                             │  │  │
│   │  └───────────────────────────────────────────────────────────────────────────┘  │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                    </pre>
                </div>

                <div class="workflow-box rounded-xl p-6 mb-4 phase-automated">
                    <h3 class="text-green-400 font-bold mb-4"><i class="fas fa-cog mr-2"></i>4.2 Entity Mapping</h3>
                    <pre class="text-gray-300 text-sm">
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              ENTITY MAPPING                                              │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   Entity Type         Column                    Purpose                                 │
│   ─────────────────────────────────────────────────────────────────────────────────────│
│   Host                DeviceName                Links to device entity graph           │
│   IP                  DeviceId                  Network correlation                    │
│                                                                                         │
│   Custom Details (passed to Logic App):                                                │
│   ─────────────────────────────────────────────────────────────────────────────────────│
│   CveId               CVE identifier                                                   │
│   RiskScore           Calculated priority score                                        │
│   PriorityTier        Critical/High/Medium/Low                                         │
│   SLA_Days            Remediation deadline                                             │
│   AssetOwner          From CMDB                                                        │
│   BusinessUnit        For routing                                                      │
│   InKEV               CISA KEV flag                                                    │
│   RecommendedAction   Human-readable guidance                                          │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                    </pre>
                </div>
            </section>

            <!-- PHASE 5 -->
            <section>
                <h2 class="text-2xl font-bold text-white mb-4">
                    <span class="text-red-400">5.</span> Automation Trigger (Logic Apps)
                    <span class="ml-3 px-3 py-1 bg-emerald-500/20 text-emerald-400 text-sm rounded-full">YOUR AUTOMATION</span>
                </h2>

                <div class="workflow-box rounded-xl p-6 mb-4 phase-automated">
                    <h3 class="text-green-400 font-bold mb-4"><i class="fas fa-project-diagram mr-2"></i>5.1 Logic App Workflow Diagram</h3>
                    <pre class="text-gray-300 text-sm">
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                    LOGIC APP: Vuln-ProcessHighRiskFindings                               │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │  TRIGGER: When Azure Sentinel alert is triggered                                │  │
│   │           Alert Rule: "High-Risk Vulnerability Detected"                        │  │
│   └───────────────────────────────────┬─────────────────────────────────────────────┘  │
│                                       │                                                 │
│                                       ▼                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │  STEP 1: Parse Alert Entities                                                   │  │
│   │                                                                                  │  │
│   │  • Extract custom details from alert                                            │  │
│   │  • Get list of all vulnerability findings                                       │  │
│   │  • Parse JSON array of results                                                  │  │
│   └───────────────────────────────────┬─────────────────────────────────────────────┘  │
│                                       │                                                 │
│                                       ▼                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │  STEP 2: De-duplication Check                                                   │  │
│   │                                                                                  │  │
│   │  For each finding:                                                              │  │
│   │  • Query SharePoint list: "Was this CVE+Device processed in last 24h?"          │  │
│   │  • If YES → Skip (already in pipeline)                                          │  │
│   │  • If NO → Continue processing                                                  │  │
│   └───────────────────────────────────┬─────────────────────────────────────────────┘  │
│                                       │                                                 │
│                                       ▼                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │  STEP 3: Group by Business Unit / Owner                                         │  │
│   │                                                                                  │  │
│   │  • Group findings by BusinessUnit                                               │  │
│   │  • Group findings by AssetOwner                                                 │  │
│   │  • Prepare summary counts                                                       │  │
│   └───────────────────────────────────┬─────────────────────────────────────────────┘  │
│                                       │                                                 │
│                                       ▼                                                 │
│           ┌───────────────────────────┼───────────────────────────┐                    │
│           │                           │                           │                    │
│           ▼                           ▼                           ▼                    │
│   ┌───────────────┐           ┌───────────────┐           ┌───────────────┐           │
│   │ OUTPUT 1:     │           │ OUTPUT 2:     │           │ OUTPUT 3:     │           │
│   │ CSV to        │           │ Power BI      │           │ ServiceNow    │           │
│   │ SharePoint    │           │ Dataset       │           │ Tickets       │           │
│   │               │           │               │           │               │           │
│   │ Path:         │           │ Push rows to  │           │ For Critical  │           │
│   │ /Security/    │           │ streaming     │           │ only:         │           │
│   │ VulnMgmt/     │           │ dataset       │           │ Auto-create   │           │
│   │ Daily/        │           │               │           │ ticket        │           │
│   │ YYYY-MM-DD.csv│           │               │           │               │           │
│   └───────────────┘           └───────────────┘           └───────────────┘           │
│           │                           │                           │                    │
│           └───────────────────────────┼───────────────────────────┘                    │
│                                       │                                                 │
│                                       ▼                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │  STEP 4: Send Notifications                                                     │  │
│   │                                                                                  │  │
│   │  Teams Adaptive Card to #vuln-management channel:                               │  │
│   │  ┌────────────────────────────────────────────────────────────────────────────┐ │  │
│   │  │  🔴 12 Critical | 🟠 34 High vulnerabilities require review                 │ │  │
│   │  │                                                                            │ │  │
│   │  │  Top Impacted Assets:                                                      │ │  │
│   │  │  • DC-01 (5 critical)                                                      │ │  │
│   │  │  • WEB-PROD-01 (3 critical, 2 high)                                        │ │  │
│   │  │                                                                            │ │  │
│   │  │  [View Dashboard]  [Download CSV]  [Open ServiceNow Queue]                 │ │  │
│   │  └────────────────────────────────────────────────────────────────────────────┘ │  │
│   │                                                                                  │  │
│   │  Email to vuln-team@company.com:                                                │  │
│   │  Subject: "Daily Vulnerability Review Queue - {date}"                           │  │
│   │  Attachment: CSV file                                                           │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                    </pre>
                </div>

                <!-- Logic App JSON Definition -->
                <div class="workflow-box rounded-xl p-6 mb-4 phase-automated">
                    <h3 class="text-green-400 font-bold mb-4"><i class="fas fa-code mr-2"></i>5.2 Logic App Actions (Pseudo-Code)</h3>
                    <div class="bg-black/50 rounded-lg p-4 overflow-x-auto">
                        <pre class="text-xs text-cyan-400">
// ============================================================================
// LOGIC APP: Vuln-ProcessHighRiskFindings
// Trigger: Sentinel Alert
// ============================================================================

// ----- TRIGGER -----
{
  "trigger": "Microsoft_Sentinel_alert",
  "alert_rule": "High-Risk Vulnerability Detected"
}

// ----- STEP 1: Initialize Variables -----
Initialize_CriticalCount = 0
Initialize_HighCount = 0
Initialize_FindingsArray = []
Initialize_ProcessedItems = []

// ----- STEP 2: Parse Alert Custom Details -----
Parse_JSON: @{triggerBody()?['ExtendedProperties']}
// Contains: Array of {DeviceName, CveId, RiskScore, PriorityTier, AssetOwner, etc.}

// ----- STEP 3: For Each Finding -----
For_Each_Finding:
  
  // Check deduplication (SharePoint list query)
  Check_Processed = SharePoint_GetItems(
    Site: "SecurityOperations",
    List: "VulnProcessingLog",
    Filter: "CVE eq '@{item().CveId}' and Device eq '@{item().DeviceName}' 
             and ProcessedDate ge '@{addDays(utcNow(), -1)}'"
  )
  
  If (length(Check_Processed) == 0):  // Not processed in last 24h
    
    // Add to findings array
    Append_To_Array(FindingsArray, {
      DeviceName: item().DeviceName,
      CveId: item().CveId,
      RiskScore: item().RiskScore,
      PriorityTier: item().PriorityTier,
      SLA_Days: item().SLA_Days,
      AssetOwner: item().AssetOwner,
      BusinessUnit: item().BusinessUnit,
      InKEV: item().InKEV,
      RecommendedAction: item().RecommendedAction,
      ProcessedDate: utcNow()
    })
    
    // Increment counters
    If (item().PriorityTier == "Critical"):
      Increment_CriticalCount
    If (item().PriorityTier == "High"):
      Increment_HighCount
    
    // Log to dedup list
    SharePoint_CreateItem(
      Site: "SecurityOperations",
      List: "VulnProcessingLog",
      CVE: item().CveId,
      Device: item().DeviceName,
      ProcessedDate: utcNow()
    )

// ----- STEP 4: Generate CSV -----
Create_CSV_Table = createCsvTable(FindingsArray)

SharePoint_CreateFile(
  Site: "SecurityOperations",
  FolderPath: "/Security/VulnMgmt/DailyReview",
  FileName: "@{formatDateTime(utcNow(), 'yyyy-MM-dd')}_VulnReview.csv",
  FileContent: Create_CSV_Table
)

// ----- STEP 5: Push to Power BI -----
For_Each_Finding_In_Array:
  PowerBI_AddRowsToDataset(
    Dataset: "VulnerabilityDashboard",
    Table: "DailyFindings",
    Row: current_finding
  )

// ----- STEP 6: Create ServiceNow Tickets (Critical Only) -----
Filter_Critical = Filter(FindingsArray, PriorityTier == "Critical")

For_Each_Critical:
  ServiceNow_CreateIncident(
    ShortDescription: "Critical Vulnerability: @{item().CveId} on @{item().DeviceName}",
    Description: "Risk Score: @{item().RiskScore}\n
                  CISA KEV: @{item().InKEV}\n
                  SLA: @{item().SLA_Days} days\n
                  Action: @{item().RecommendedAction}",
    AssignmentGroup: item().SupportGroup,
    AssignedTo: item().AssetOwner,
    Priority: 2,  // High
    Category: "Vulnerability",
    DueDate: addDays(utcNow(), item().SLA_Days)
  )

// ----- STEP 7: Send Teams Notification -----
Teams_PostAdaptiveCard(
  Channel: "#vuln-management",
  Card: {
    Title: "Daily Vulnerability Review Queue",
    Body: [
      {
        type: "ColumnSet",
        columns: [
          { header: "🔴 Critical", value: CriticalCount },
          { header: "🟠 High", value: HighCount }
        ]
      },
      {
        type: "TextBlock",
        text: "Review required for prioritized vulnerabilities"
      }
    ],
    Actions: [
      { type: "OpenUrl", title: "View Dashboard", url: PowerBI_Dashboard_URL },
      { type: "OpenUrl", title: "Download CSV", url: SharePoint_CSV_URL },
      { type: "OpenUrl", title: "ServiceNow Queue", url: ServiceNow_Queue_URL }
    ]
  }
)

// ----- STEP 8: Send Email Summary -----
Outlook_SendEmail(
  To: "vuln-team@company.com",
  Subject: "Daily Vulnerability Review - @{formatDateTime(utcNow(), 'yyyy-MM-dd')}",
  Body: "
    <h2>Vulnerability Review Queue</h2>
    <p>Critical: @{CriticalCount} | High: @{HighCount}</p>
    <p>Please review the attached CSV and take appropriate action.</p>
    <p><a href='@{PowerBI_Dashboard_URL}'>Open Dashboard</a></p>
  ",
  Attachments: [SharePoint_CSV_File]
)
                        </pre>
                    </div>
                </div>

                <!-- Output Examples -->
                <div class="workflow-box rounded-xl p-6 mb-4 phase-automated">
                    <h3 class="text-green-400 font-bold mb-4"><i class="fas fa-file-export mr-2"></i>5.3 Output Examples</h3>
                    
                    <div class="grid grid-cols-1 gap-4">
                        <!-- CSV Output -->
                        <div class="bg-black/30 rounded-lg p-4">
                            <p class="text-yellow-400 font-semibold text-sm mb-2">CSV Output (SharePoint):</p>
                            <pre class="text-xs text-gray-400 overflow-x-auto">
DeviceName,CveId,CvssScore,EPSS,InKEV,RiskScore,PriorityTier,SLA_Days,AssetOwner,BusinessUnit,RecommendedAction
DC-01,CVE-2024-1234,9.8,0.92,TRUE,325,Critical,2,john.doe@company.com,IT-Infrastructure,"URGENT: CISA KEV overdue - patch immediately"
WEB-PROD-01,CVE-2024-5678,8.5,0.75,TRUE,280,Critical,2,jane.smith@company.com,Web-Services,"CISA KEV - patch by 2024-02-15"
APP-SERVER-03,CVE-2024-9012,7.5,0.45,FALSE,165,High,7,dev.team@company.com,Applications,"High risk - patch within 7 days"
                            </pre>
                        </div>

                        <!-- Teams Notification -->
                        <div class="bg-black/30 rounded-lg p-4">
                            <p class="text-yellow-400 font-semibold text-sm mb-2">Teams Adaptive Card:</p>
                            <div class="bg-gray-800 rounded-lg p-3 text-sm">
                                <p class="text-white font-bold">🛡️ Daily Vulnerability Review Queue</p>
                                <div class="flex gap-4 my-2">
                                    <span class="text-red-400">🔴 Critical: 12</span>
                                    <span class="text-orange-400">🟠 High: 34</span>
                                </div>
                                <p class="text-gray-400 text-xs mb-2">Top Impacted Assets:</p>
                                <ul class="text-gray-400 text-xs">
                                    <li>• DC-01 (5 critical) - IT-Infrastructure</li>
                                    <li>• WEB-PROD-01 (3 critical, 2 high) - Web-Services</li>
                                </ul>
                                <div class="flex gap-2 mt-3">
                                    <span class="px-2 py-1 bg-blue-500/20 text-blue-400 text-xs rounded">View Dashboard</span>
                                    <span class="px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded">Download CSV</span>
                                    <span class="px-2 py-1 bg-purple-500/20 text-purple-400 text-xs rounded">ServiceNow Queue</span>
                                </div>
                            </div>
                        </div>

                        <!-- ServiceNow Ticket -->
                        <div class="bg-black/30 rounded-lg p-4">
                            <p class="text-yellow-400 font-semibold text-sm mb-2">ServiceNow Ticket (Auto-Created for Critical):</p>
                            <div class="bg-gray-800 rounded-lg p-3 text-xs">
                                <p class="text-white font-bold">INC0012345: Critical Vulnerability: CVE-2024-1234 on DC-01</p>
                                <div class="grid grid-cols-2 gap-2 mt-2 text-gray-400">
                                    <p><span class="text-gray-500">Priority:</span> 2 - High</p>
                                    <p><span class="text-gray-500">Category:</span> Vulnerability</p>
                                    <p><span class="text-gray-500">Assigned To:</span> john.doe@company.com</p>
                                    <p><span class="text-gray-500">Due Date:</span> 2024-01-17 (48h SLA)</p>
                                </div>
                                <p class="text-gray-400 mt-2">
                                    <span class="text-gray-500">Description:</span><br>
                                    Risk Score: 325<br>
                                    CISA KEV: Yes (actively exploited)<br>
                                    EPSS: 0.92 (92% exploit probability)<br>
                                    Action: URGENT - Apply patch KB5001234 immediately
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PHASE 6 -->
            <section>
                <h2 class="text-2xl font-bold text-white mb-4">
                    <span class="text-red-400">6.</span> Vulnerability Analyst Consumption (Human Review)
                </h2>
                <div class="workflow-box rounded-xl p-6 mb-4 phase-manual">
                    <h3 class="text-yellow-400 font-bold mb-4"><i class="fas fa-user mr-2"></i>6.1 What Analysts Actually See</h3>
                    <pre class="text-gray-300 text-sm">
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                         VULNERABILITY ANALYST WORKSPACE                                  │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│   ❌ ANALYSTS DO NOT:                                                                   │
│      • Open Sentinel incidents                                                          │
│      • Work from SOC queue                                                              │
│                                                                                         │
│   ✅ ANALYSTS WORK FROM:                                                                │
│      • Power BI Dashboards (interactive, drill-down)                                   │
│      • CSV Exports (filterable, bulk actions)                                          │
│      • Ticket Queues (ServiceNow/Jira)                                                 │
│                                                                                         │
│   VIEW CONTAINS:                                                                        │
│   ┌─────────┬──────────┬───────────┬──────┬─────┬──────────┬────────────────┐          │
│   │ Asset   │ CVE      │ RiskScore │ EPSS │ KEV │ Exposure │ Recommended    │          │
│   ├─────────┼──────────┼───────────┼──────┼─────┼──────────┼────────────────┤          │
│   │ DC-01   │ 2024-123 │ 285       │ 0.92 │ ✓   │ Internal │ Patch ASAP     │          │
│   │ WEB-03  │ 2024-456 │ 210       │ 0.75 │ ✓   │ Internet │ Patch + WAF    │          │
│   └─────────┴──────────┴───────────┴──────┴─────┴──────────┴────────────────┘          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                    </pre>
                </div>
            </section>

            <!-- PHASE 7 -->
            <section>
                <h2 class="text-2xl font-bold text-white mb-4">
                    <span class="text-red-400">7.</span> Manual Analyst Workflow (Validation Phase)
                </h2>
                <div class="bg-yellow-500/10 border border-yellow-500/50 rounded-xl p-4 mb-4">
                    <p class="text-yellow-400 font-bold"><i class="fas fa-exclamation-triangle mr-2"></i>This step is mandatory and expected. Not every finding becomes a ticket.</p>
                </div>
                <div class="workflow-box rounded-xl p-6 mb-4 phase-manual">
                    <h3 class="text-yellow-400 font-bold mb-4"><i class="fas fa-clipboard-check mr-2"></i>7.1 Analyst Review Steps</h3>
                    <pre class="text-gray-300 text-sm">
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           ANALYST VALIDATION WORKFLOW                                    │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│   FOR EACH ITEM:                                                                        │
│                                                                                         │
│   1. VALIDATE VULNERABILITY ACCURACY                                                    │
│      □ Is the scanner detection correct?                                               │
│      □ Does the CVE apply to our config?                                               │
│                                                                                         │
│   2. CHECK COMPENSATING CONTROLS                                                        │
│      □ Mitigated by NGFW rules?                                                        │
│      □ Mitigated by EDR protection?                                                    │
│      □ Network segmentation blocking attack path?                                      │
│                                                                                         │
│   3. ASSESS PATCH IMPACT                                                                │
│      □ OT/ICS system? → Vendor approval required                                       │
│      □ Legacy system? → May break application                                          │
│      □ Critical workload? → Needs change window                                        │
│                                                                                         │
│   4. DISPOSITION DECISION                                                               │
│      ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │
│      │  FIX NOW    │  │   DEFER     │  │ ACCEPT RISK │  │  CLOSE FP   │                │
│      │  → Ticket   │  │  → Schedule │  │  → Document │  │  → Exclude  │                │
│      └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘                │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                    </pre>
                </div>
            </section>

            <!-- PHASE 8 -->
            <section>
                <h2 class="text-2xl font-bold text-white mb-4">
                    <span class="text-red-400">8.</span> Ticket Creation & Assignment
                </h2>
                <div class="workflow-box rounded-xl p-6 mb-4 phase-automated">
                    <h3 class="text-green-400 font-bold mb-4"><i class="fas fa-ticket-alt mr-2"></i>8.1 Ticket Creation Methods</h3>
                    <pre class="text-gray-300 text-sm">
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│   OPTION A: AUTOMATED - Logic App creates tickets automatically                         │
│   OPTION B: SEMI-AUTOMATED - Analyst approves in dashboard, triggers ticket            │
│   OPTION C: BULK IMPORT - Analyst filters CSV, imports to ServiceNow/Jira              │
│                                                                                         │
│   TICKET INCLUDES: CVE, Asset, RiskScore, SLA, Owner, Remediation steps                │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                    </pre>
                </div>
            </section>

            <!-- PHASE 9 -->
            <section>
                <h2 class="text-2xl font-bold text-white mb-4">
                    <span class="text-red-400">9.</span> Ticket Routing to Owners
                </h2>
                <div class="workflow-box rounded-xl p-6 mb-4 phase-automated">
                    <h3 class="text-green-400 font-bold mb-4"><i class="fas fa-route mr-2"></i>9.1 CMDB Ownership Mapping</h3>
                    <pre class="text-gray-300 text-sm">
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│   CMDB MAPPING: Asset → Application Owner / Infrastructure Owner / Support Group        │
│                                                                                         │
│   OWNERS RECEIVE:                                                                       │
│   ✓ Clear remediation instructions                                                      │
│   ✓ SLA expectations                                                                    │
│   ✓ Risk context (KEV, EPSS, exposure)                                                 │
│   ✓ Escalation path                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                    </pre>
                </div>
            </section>

            <!-- PHASE 10 -->
            <section>
                <h2 class="text-2xl font-bold text-white mb-4">
                    <span class="text-red-400">10.</span> Closure, Feedback & Continuous Improvement
                </h2>
                <div class="workflow-box rounded-xl p-6 mb-4 phase-automated">
                    <h3 class="text-green-400 font-bold mb-4"><i class="fas fa-sync-alt mr-2"></i>10.1 Feedback Loop</h3>
                    <pre class="text-gray-300 text-sm">
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│   TICKET OUTCOMES FEED BACK INTO:                                                       │
│   • Risk Scoring Logic (adjust weights)                                                │
│   • Prioritization Thresholds (raise/lower based on capacity)                          │
│   • Exception Handling (auto-approval rules for known exceptions)                      │
│                                                                                         │
│   THIS CONTINUOUSLY:                                                                    │
│   ✓ Reduces false positives over time                                                  │
│   ✓ Improves prioritization accuracy                                                   │
│   ✓ Adjusts SLAs based on actual remediation capacity                                 │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                    </pre>
                </div>
            </section>

            <!-- PHASE 11 -->
            <section>
                <h2 class="text-2xl font-bold text-white mb-4">
                    <span class="text-red-400">11.</span> SOC Involvement (Only When Needed)
                    <span class="ml-3 px-3 py-1 bg-purple-500/20 text-purple-400 text-sm rounded-full">SEPARATE WORKFLOW</span>
                </h2>
                <div class="workflow-box rounded-xl p-6 mb-4 phase-soc">
                    <h3 class="text-purple-400 font-bold mb-4"><i class="fas fa-shield-alt mr-2"></i>11.1 When SOC Engages</h3>
                    <pre class="text-gray-300 text-sm">
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                         SOC INVOLVEMENT (SEPARATE WORKFLOW)                              │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│   SOC ONLY ENGAGES IF a SEPARATE correlation rule detects:                              │
│                                                                                         │
│   • NGFW detects exploit traffic matching a known CVE                                  │
│   • EDR detects suspicious endpoint behavior (exploitation attempt)                    │
│   • IDS/IPS signature triggers for vulnerability exploitation                          │
│                                                                                         │
│   THEN:                                                                                 │
│   ├── Correlation rule creates Sentinel INCIDENT (not just alert)                      │
│   ├── Incident assigned to SOC queue                                                   │
│   └── SOC investigates active exploitation attempt                                     │
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │  Vulnerability data = CONTEXT for investigation, not the driver                 │  │
│   │  Exploit detection = DRIVER of SOC investigation                                │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                    </pre>
                </div>

                <!-- SOC Incident Correlation Rule -->
                <div class="workflow-box rounded-xl p-6 mb-4 phase-soc">
                    <h3 class="text-purple-400 font-bold mb-4"><i class="fas fa-code mr-2"></i>11.2 SOC Incident Correlation Rule (Vuln + NGFW + Endpoint)</h3>
                    <p class="text-gray-400 text-sm mb-4">This rule triggers a SOC incident ONLY when: (1) Host is high-risk vulnerable, AND (2) NGFW detects exploit/threat signal, AND (3) Endpoint shows confirming suspicious behavior.</p>
                    <div class="bg-black/50 rounded-lg p-4 overflow-x-auto">
                        <pre class="text-xs text-purple-400">
// ===============================
// INCIDENT CORRELATION: VULN + NGFW + ENDPOINT
// Scheduled Analytics Rule - Runs every 15-60 minutes
// Incident Creation: ON (this IS for SOC triage)
// ===============================

let Lookback = 24h;
let MinRiskScoreForIncident = 85;
let CorrelationWindow = 30m;

// ---- Build prioritized vulnerable hosts (reuse scoring logic) ----
let PrioritizedVulns =
    QualysVuln_CL
    | where todatetime(LastDetected) > ago(14d)
    | extend AssetId=tostring(AssetId), AssetIP=tostring(AssetIP), AssetName=tostring(AssetName),
             CVE=tostring(CVE), Cvss=todouble(Cvss), LastDetected=todatetime(LastDetected)
    | summarize Cvss=max(Cvss), LastDetected=max(LastDetected), AnyName=any(AssetName), AnyIP=any(AssetIP) by AssetId, CVE
    | join kind=leftouter EPSS_CL on CVE
    | join kind=leftouter CISA_KEV_CL on CVE
    | join kind=leftouter CMDBAssets_Watchlist on AssetId
    | extend
        EpssScore = todouble(EpssScore),
        IsKEV = tobool(IsKEV),
        IsInternetFacing = tobool(IsInternetFacing),
        CriticalityTier = toint(CriticalityTier),
        // Scoring (keep consistent with backlog scoring)
        RiskScore = round((Cvss * 3) + (coalesce(EpssScore,0.0) * 40) + iff(IsKEV,25,0) 
                    + iff(IsInternetFacing,15,0) + (case(CriticalityTier==0,45, CriticalityTier==1,30, 
                    CriticalityTier==2,15, 10)), 1)
    | where RiskScore >= MinRiskScoreForIncident
    | project AssetId, AssetName=AnyName, AssetIP=AnyIP, CVE, Cvss, EpssScore, IsKEV, 
              IsInternetFacing, CriticalityTier, RiskScore;

// ---- NGFW exploitation / threat signal targeting the host ----
let NGFWThreatSignals =
    CommonSecurityLog
    | where TimeGenerated > ago(Lookback)
    | where DeviceVendor has_any ("Palo Alto", "Fortinet", "Check Point")
    | where Activity in ("THREAT", "Threat", "TRAFFIC")
    | where LogSeverity >= 3 or DeviceAction in ("drop","deny","block","reset-both","reset-client","reset-server")
    | extend
        DstIP = tostring(DestinationIP),
        SrcIP = tostring(SourceIP),
        FWAction = tostring(DeviceAction),
        FWRule = tostring(DeviceCustomString1),
        FWThreat = tostring(ThreatDescription),
        FWCategory = tostring(ThreatCategory),
        App = tostring(ApplicationProtocol),
        DstPort = toint(DestinationPort)
    | project FW_Time=TimeGenerated, SrcIP, DstIP, DstPort, FWAction, FWRule, FWThreat, 
              FWCategory, App, DeviceVendor, DeviceProduct;

// ---- Endpoint confirmation (network + suspicious process execution) ----
let EndpointNet =
    DeviceNetworkEvents
    | where TimeGenerated > ago(Lookback)
    | extend LocalIP = tostring(LocalIP), RemoteIP=tostring(RemoteIP)
    | project EDRN_Time=TimeGenerated, DeviceId, DeviceName, LocalIP, RemoteIP, RemotePort, 
              InitiatingProcessFileName, InitiatingProcessCommandLine;

let EndpointProc =
    DeviceProcessEvents
    | where TimeGenerated > ago(Lookback)
    | where FileName in~ ("powershell.exe","cmd.exe","wscript.exe","cscript.exe","mshta.exe",
                          "rundll32.exe","regsvr32.exe")
       or ProcessCommandLine has_any ("-enc","EncodedCommand","IEX","FromBase64String",
                                       "Invoke-WebRequest","bitsadmin")
    | project EDRP_Time=TimeGenerated, DeviceId, DeviceName, AccountName, FileName, 
              ProcessCommandLine, InitiatingProcessFileName;

// ---- Correlate: vulnerable host + firewall signal + endpoint activity ----
PrioritizedVulns
| join kind=inner NGFWThreatSignals on $left.AssetIP == $right.DstIP
| where abs(datetime_diff("minute", FW_Time, now())) <= 24*60
| join kind=leftouter EndpointNet on $left.AssetIP == $right.LocalIP
| extend
    WithinWindow_Net = iff(isnotempty(EDRN_Time) and abs(datetime_diff("minute", FW_Time, EDRN_Time)) 
                       <= toint(CorrelationWindow/1m), true, false)
| join kind=leftouter EndpointProc on DeviceId
| extend
    WithinWindow_Proc = iff(isnotempty(EDRP_Time) and abs(datetime_diff("minute", FW_Time, EDRP_Time)) 
                        <= toint(CorrelationWindow/1m), true, false),
    Confidence = case(
        WithinWindow_Net and WithinWindow_Proc, "High",
        WithinWindow_Net and not(WithinWindow_Proc), "Medium",
        not(WithinWindow_Net) and WithinWindow_Proc, "Medium",
        "Low"
    )
| where Confidence in ("High","Medium")   // Gate incident creation
| project
    TimeGenerated = FW_Time,
    Confidence,
    RiskScore,
    AssetId,
    AssetName,
    AssetIP,
    CVE,
    Cvss,
    EpssScore,
    IsKEV,
    IsInternetFacing,
    CriticalityTier,
    // Firewall evidence
    DeviceVendor,
    DeviceProduct,
    SrcIP,
    DstPort,
    FWAction,
    FWThreat,
    FWCategory,
    FWRule,
    App,
    // Endpoint evidence
    DeviceName,
    InitiatingProcessFileName,
    InitiatingProcessCommandLine,
    FileName,
    ProcessCommandLine
| order by RiskScore desc, TimeGenerated desc
                        </pre>
                    </div>
                    
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-black/30 rounded-lg p-3">
                            <p class="text-purple-400 font-semibold text-sm mb-2">Confidence Levels:</p>
                            <ul class="text-gray-400 text-xs space-y-1">
                                <li>• <strong class="text-red-400">High:</strong> NGFW threat + Network activity + Suspicious process (all within 30m)</li>
                                <li>• <strong class="text-yellow-400">Medium:</strong> NGFW threat + Either network OR process correlation</li>
                                <li>• <strong class="text-gray-500">Low:</strong> NGFW threat only (no endpoint confirmation) → No incident</li>
                            </ul>
                        </div>
                        <div class="bg-black/30 rounded-lg p-3">
                            <p class="text-purple-400 font-semibold text-sm mb-2">Sentinel Rule Settings:</p>
                            <ul class="text-gray-400 text-xs space-y-1">
                                <li>• <strong>Frequency:</strong> Every 15-60 minutes</li>
                                <li>• <strong>Incident Creation:</strong> ✅ ON</li>
                                <li>• <strong>Group by:</strong> AssetIP + CVE</li>
                                <li>• <strong>Severity:</strong> High if Confidence=High or IsKEV=true</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Production KQL: Prioritized Backlog -->
            <section>
                <h2 class="text-2xl font-bold text-white mb-4">
                    <i class="fas fa-file-code text-cyan-400 mr-2"></i>Production KQL: Prioritized Vulnerability Backlog
                </h2>
                <p class="text-gray-400 text-sm mb-4">This rule generates a deduped, risk-scored backlog of vulnerability items for tickets/CSV/Power BI. <strong class="text-white">Alert only, no SOC incident.</strong></p>
                
                <div class="workflow-box rounded-xl p-6 mb-4">
                    <div class="bg-black/50 rounded-lg p-4 overflow-x-auto">
                        <pre class="text-xs text-cyan-400">
// ===============================
// PRIORITIZED VULNERABILITY BACKLOG (AUTOMATION OUTPUT)
// Scheduled Analytics Rule - Alert only, no incident
// ===============================

// Tuning knobs
let Lookback = 14d;
let MinRiskScoreForTicket = 70;
let CriticalityWeight = 15;
let InternetFacingBonus = 15;
let KEVBonus = 25;
let EpssWeight = 40;             // EPSS in 0..1 scaled into 0..40
let CvssWeight = 3;              // CVSS in 0..10 scaled into 0..30

// Normalize CMDB watchlist
let CMDB =
    CMDBAssets_Watchlist
    | project
        AssetId = tostring(AssetId),
        OwnerUPN = tostring(OwnerUPN),
        BusinessUnit = tostring(BusinessUnit),
        CriticalityTier = toint(CriticalityTier),
        IsInternetFacing = tobool(IsInternetFacing);

// EPSS + KEV
let EPSS =
    EPSS_CL
    | project CVE = tostring(CVE), EpssScore = todouble(EpssScore);

let KEV =
    CISA_KEV_CL
    | project CVE = tostring(CVE), IsKEV = tobool(IsKEV);

// Qualys raw findings (dedupe to latest per AssetId+CVE)
let QualysFindings =
    QualysVuln_CL
    | where todatetime(LastDetected) > ago(Lookback)
    | extend
        AssetId = tostring(AssetId),
        AssetName = tostring(AssetName),
        AssetIP = tostring(AssetIP),
        CVE = tostring(CVE),
        Cvss = todouble(Cvss),
        LastDetected = todatetime(LastDetected),
        FirstDetected = todatetime(FirstDetected),
        Port = toint(Port),
        Protocol = tostring(Protocol)
    | summarize
        LastDetected = max(LastDetected),
        FirstDetected = min(FirstDetected),
        AnyAssetName = any(AssetName),
        AnyAssetIP = any(AssetIP),
        AnyPort = any(Port),
        AnyProto = any(Protocol),
        Cvss = max(Cvss)
      by AssetId, CVE;

// Enrich + risk score
QualysFindings
| join kind=leftouter EPSS on CVE
| join kind=leftouter KEV on CVE
| join kind=leftouter CMDB on AssetId
| extend
    CriticalityScore =
        case(
            CriticalityTier == 0, 3,
            CriticalityTier == 1, 2,
            CriticalityTier == 2, 1,
            CriticalityTier == 3, 0,
            1
        ) * CriticalityWeight,
    CvssScore = Cvss * CvssWeight,
    EpssScoreScaled = coalesce(EpssScore, 0.0) * EpssWeight,
    KevScore = iff(IsKEV == true, KEVBonus, 0),
    ExposureScore = iff(IsInternetFacing == true, InternetFacingBonus, 0),
    RiskScore = round(CvssScore + EpssScoreScaled + KevScore + ExposureScore + CriticalityScore, 1)
| where RiskScore >= MinRiskScoreForTicket
| project
    TimeGenerated = now(),
    AssetId,
    AssetName = AnyAssetName,
    AssetIP = AnyAssetIP,
    CVE,
    Cvss,
    EpssScore,
    IsKEV,
    IsInternetFacing,
    CriticalityTier,
    OwnerUPN,
    BusinessUnit,
    ServicePort = AnyPort,
    ServiceProtocol = AnyProto,
    FirstDetected,
    LastDetected,
    RiskScore
| order by RiskScore desc, LastDetected desc
                        </pre>
                    </div>
                    
                    <div class="mt-4 bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-4">
                        <p class="text-emerald-400 font-semibold text-sm mb-2"><i class="fas fa-cogs mr-2"></i>Operational Use:</p>
                        <ul class="text-gray-400 text-xs space-y-1">
                            <li>• Scheduled analytics rule runs every X hours</li>
                            <li>• <strong class="text-white">Alert only</strong> (no SOC incident)</li>
                            <li>• Logic App takes results → exports CSV / updates Power BI / creates tickets</li>
                            <li>• Often one ticket per asset with list of CVEs, or one ticket per CVE family per owner</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Summary Flow -->
            <section>
                <h2 class="text-2xl font-bold text-white mb-4">Complete 11-Phase Flow</h2>
                <div class="workflow-box rounded-xl p-6">
                    <pre class="text-gray-300 text-xs overflow-x-auto">
┌────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ 1.SCAN → 2.INGEST → 3.ENRICH → 4.ALERT → 5.AUTOMATE → 6.CONSUME → 7.VALIDATE → 8.TICKET → 9.ROUTE → 10.CLOSE │
│ Qualys   Sentinel   EPSS/KEV   (no      Logic App   Power BI   Manual FP   ServiceNow  CMDB→     Feedback  │
│ TVM      Raw data   CMDB join  incident)            CSV        check       Jira        Owner     Loop      │
│                                                                                                            │
│ ═══════════════════════════════════════════════════════════════════════════════════════════════════════════│
│ 11. SOC (SEPARATE) - Only when NGFW/EDR detects active exploitation → Creates INCIDENT → SOC investigates │
└────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
                    </pre>
                </div>
            </section>

            <!-- Environment Scope -->
            <div class="glass-card rounded-xl p-6 mt-8">
                <h3 class="text-xl font-bold text-white mb-4"><i class="fas fa-building text-blue-400 mr-2"></i>Environment Scope & Metrics</h3>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 text-center">
                        <p class="text-3xl font-bold text-blue-400">5,000+</p>
                        <p class="text-gray-400 text-sm">Endpoints</p>
                    </div>
                    <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4 text-center">
                        <p class="text-3xl font-bold text-green-400">2,500+</p>
                        <p class="text-gray-400 text-sm">Employees</p>
                    </div>
                    <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4 text-center">
                        <p class="text-3xl font-bold text-purple-400">~50K</p>
                        <p class="text-gray-400 text-sm">Raw Findings/Week</p>
                    </div>
                    <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 text-center">
                        <p class="text-3xl font-bold text-red-400">~200</p>
                        <p class="text-gray-400 text-sm">Actionable/Week</p>
                    </div>
                </div>

                <div class="bg-black/30 rounded-lg p-4">
                    <p class="text-yellow-400 font-semibold mb-2"><i class="fas fa-filter mr-2"></i>Noise Reduction Impact:</p>
                    <p class="text-gray-300 text-sm">
                        Raw vulnerability scans across 5,000+ endpoints generated approximately <strong class="text-white">50,000+ findings per week</strong>. 
                        After risk-scoring with EPSS, CISA KEV, asset criticality, and exposure context, the pipeline filtered this down to 
                        approximately <strong class="text-white">200 actionable Critical/High findings</strong>—a <strong class="text-emerald-400">99.6% noise reduction</strong> 
                        that allowed vulnerability analysts to focus on what actually mattered.
                    </p>
                </div>
            </div>

            <!-- Role Positioning -->
            <div class="bg-amber-500/10 border border-amber-500/50 rounded-xl p-6 mt-6">
                <h3 class="text-amber-400 font-bold mb-3"><i class="fas fa-user-cog mr-2"></i>My Role: Migration & Engineering Support</h3>
                <p class="text-gray-300 text-sm mb-4">
                    The subsidiary's SOC remained operational throughout the RSA NetWitness to Microsoft Sentinel migration. 
                    My role was <strong class="text-white">migration and engineering support</strong>—building the detection rules, 
                    correlation logic, automation pipelines, and dashboards—followed by a <strong class="text-white">structured handover</strong> 
                    to the subsidiary's internal security team for steady-state operations.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="text-amber-400 font-semibold mb-2">What I Built:</p>
                        <ul class="text-gray-400 space-y-1">
                            <li>• Vulnerability risk-scoring correlation rules</li>
                            <li>• Logic App automation pipelines</li>
                            <li>• Power BI dashboards</li>
                            <li>• Watchlist ingestion workflows</li>
                            <li>• ServiceNow integration</li>
                        </ul>
                    </div>
                    <div>
                        <p class="text-amber-400 font-semibold mb-2">Handover Deliverables:</p>
                        <ul class="text-gray-400 space-y-1">
                            <li>• Runbook documentation</li>
                            <li>• SOC training sessions</li>
                            <li>• Workbook templates</li>
                            <li>• Tuning guidelines</li>
                            <li>• Escalation procedures</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Interview Talking Points -->
            <div class="glass-card rounded-xl p-6 mt-8">
                <h3 class="text-xl font-bold text-white mb-4"><i class="fas fa-microphone text-red-400 mr-2"></i>Interview Talking Points</h3>
                <div class="space-y-4 text-sm">
                    <div class="bg-black/30 rounded-lg p-4">
                        <p class="text-yellow-400 font-semibold mb-2">Q: "How do you prioritize vulnerabilities?"</p>
                        <p class="text-gray-300">"In our environment of 5,000+ endpoints supporting 2,500 employees, raw vulnerability scans generated around 50,000 findings per week. I built a risk-scoring pipeline in Sentinel that joined TVM and Qualys data with EPSS, CISA KEV, CMDB asset criticality, and exposure context. The calculated risk score—not just CVSS—determined priority and SLA. This filtered 50,000 findings down to about 200 actionable Critical/High items per week, a 99%+ noise reduction."</p>
                    </div>
                    <div class="bg-black/30 rounded-lg p-4">
                        <p class="text-yellow-400 font-semibold mb-2">Q: "Does SOC triage vulnerability alerts?"</p>
                        <p class="text-gray-300">"No—vulnerability management is a separate workflow from SOC incident response. My pipeline produces prioritized findings that go to Power BI dashboards and CSV exports for vulnerability analysts, not the SOC queue. SOC only gets involved when a separate correlation rule detects active exploitation—like NGFW threat logs showing exploit traffic to an unpatched system. At that point, vulnerability data becomes context for the investigation, not the trigger."</p>
                    </div>
                    <div class="bg-black/30 rounded-lg p-4">
                        <p class="text-yellow-400 font-semibold mb-2">Q: "What was your role versus the SOC team?"</p>
                        <p class="text-gray-300">"The SOC remained operational throughout; my role was migration and engineering support. I built the correlation rules, automation pipelines, dashboards, and integrations—then conducted a structured handover to the subsidiary's internal security team. I delivered runbooks, training, workbook templates, and tuning guidelines so they could own steady-state operations. I wasn't running the SOC day-to-day; I was enabling it with modern tooling."</p>
                    </div>
                    <div class="bg-black/30 rounded-lg p-4">
                        <p class="text-yellow-400 font-semibold mb-2">Q: "How did you measure success of the vulnerability pipeline?"</p>
                        <p class="text-gray-300">"Three key metrics: First, noise reduction—going from 50K to 200 actionable findings per week. Second, SLA compliance—tracking what percentage of Critical vulnerabilities were remediated within 48 hours. Third, false positive rate—feeding analyst dispositions back into the scoring logic to continuously improve prioritization accuracy. We also tracked CISA KEV compliance separately since those have federal deadlines."</p>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="flex justify-between mt-8">
                <a href="workflows-index.html" class="px-6 py-3 bg-gray-800 hover:bg-gray-700 rounded-lg text-gray-300 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>All Workflows
                </a>
                <a href="workflows-ngfw.html" class="px-6 py-3 bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 rounded-lg text-red-400 transition-colors">
                    Next: Firewall Workflows<i class="fas fa-arrow-right ml-2"></i>
                </a>
            </div>

        </div>
    </div>
</body>
</html>
